# ETL Pipeline Example Configuration
# –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

name: "Multi-Database Report"
version: "1.0"
description: "–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∑–∞–∫–∞–∑–æ–≤ –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ PostgreSQL, MS SQL Server –∏ MySQL"

# ============================================================================
# –ò–°–¢–û–ß–ù–ò–ö–ò –î–ê–ù–ù–´–• (Sources)
# ============================================================================

sources:
  # PostgreSQL - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
  - name: users  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ workspace
    type: postgres
    dsn: "postgres://user:password@localhost:5432/users_db?sslmode=disable"
    query: |
      SELECT
        user_id,
        username,
        email,
        registration_date,
        country
      FROM users
      WHERE active = true
        AND registration_date >= '2024-01-01'
      ORDER BY user_id

  # MS SQL Server - –ó–∞–∫–∞–∑—ã
  - name: orders  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ workspace
    type: mssql
    dsn: "server=localhost;user id=sa;password=YourPassword123;database=OrdersDB;encrypt=disable"
    query: |
      SELECT
        order_id,
        user_id,
        order_date,
        total_amount,
        status
      FROM Orders
      WHERE status IN ('completed', 'shipped')
        AND order_date >= '2024-01-01'

  # MySQL - –ü—Ä–æ–¥—É–∫—Ç—ã
  - name: products  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ workspace
    type: mysql
    dsn: "root:password@tcp(localhost:3306)/products_db?parseTime=true"
    query: |
      SELECT
        product_id,
        product_name,
        category,
        price
      FROM products
      WHERE in_stock = 1
        AND price > 0

# ============================================================================
# WORKSPACE (–†–∞–±–æ—á–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è JOIN)
# ============================================================================

workspace:
  type: sqlite
  mode: ":memory:"  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å (–±—ã—Å—Ç—Ä–æ)
  # mode: "workspace.db"  # –ò–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –¥–∏—Å–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

# ============================================================================
# –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Ø (SQL –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö)
# ============================================================================

transform:
  result_table: "user_order_summary"
  sql: |
    -- –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    SELECT
      u.user_id,
      u.username,
      u.email,
      u.country,
      u.registration_date,

      -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
      COUNT(DISTINCT o.order_id) as total_orders,
      COALESCE(SUM(o.total_amount), 0) as total_spent,
      MIN(o.order_date) as first_order_date,
      MAX(o.order_date) as last_order_date,

      -- –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
      (
        SELECT p.category
        FROM orders o2
        JOIN products p ON o2.order_id = p.product_id
        WHERE o2.user_id = u.user_id
        GROUP BY p.category
        ORDER BY COUNT(*) DESC
        LIMIT 1
      ) as favorite_category

    FROM users u
    LEFT JOIN orders o ON u.user_id = o.user_id
    GROUP BY
      u.user_id,
      u.username,
      u.email,
      u.country,
      u.registration_date
    HAVING total_orders > 0
    ORDER BY total_spent DESC
    LIMIT 1000

# ============================================================================
# –í–´–í–û–î (–ö—É–¥–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
# ============================================================================

output:
  type: TDTP
  tdtp:
    destination: "reports/user_order_summary.xml"
    format: "xml"
    compression: true  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å zstd —Å–∂–∞—Ç–∏–µ (—É—Ä–æ–≤–µ–Ω—å 3 - —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–≤–æ–¥–∞:

# RabbitMQ
#output:
#  type: RabbitMQ
#  rabbitmq:
#    host: localhost
#    port: 5672
#    user: guest
#    password: guest
#    queue: etl_results
#    vhost: "/"
#    exchange: ""
#    routing_key: etl_results

# Kafka
#output:
#  type: Kafka
#  kafka:
#    brokers: "localhost:9092"
#    topic: etl_results
#    partition: 0
#    compression: gzip

# ============================================================================
# –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨
# ============================================================================

performance:
  timeout: 300              # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)
  batch_size: 10000         # –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
  parallel_sources: true    # –ó–∞–≥—Ä—É–∂–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
  max_memory_mb: 2048       # –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ (MB)

# ============================================================================
# –ê–£–î–ò–¢ –ò –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# ============================================================================

audit:
  enabled: true
  log_file: "logs/etl_pipeline.log"
  log_queries: true         # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã
  log_errors: true          # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö
# ============================================================================

error_handling:
  on_source_error: "continue"    # continue | fail
  on_transform_error: "fail"     # continue | fail
  on_export_error: "fail"        # continue | fail
  retry_count: 3
  retry_delay_sec: 5

# ============================================================================
# –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï
# ============================================================================

# Safe mode (READ-ONLY, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
#   tdtpcli --pipeline etl_pipeline_example.yaml
#
# Unsafe mode (–≤—Å–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ç—Ä–µ–±—É–µ—Ç admin):
#   sudo tdtpcli --pipeline etl_pipeline_example.yaml --unsafe
#
# –†–µ–∂–∏–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
#   üîí SAFE   - –¢–æ–ª—å–∫–æ SELECT/WITH, –±–µ–∑ –ø—Ä–∞–≤ admin
#   üîì UNSAFE - –í—Å–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∞ admin
#
# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
#   üìã Pipeline: Multi-Database Report
#      –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∑–∞–∫–∞–∑–æ–≤ –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...
#      Version: 1.0
#      Mode: üîí SAFE (READ-ONLY: SELECT/WITH only)
#      Sources: 3
#      Workspace: sqlite (:memory:)
#      Output: TDTP
#
#   üöÄ Starting ETL pipeline execution...
#
#   ‚úÖ ETL Pipeline completed successfully!
#      Duration: 2.45s
#      Sources loaded: 3
#      Rows loaded: 15,234
#      Rows exported: 987
