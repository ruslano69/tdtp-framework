# Минимальный ETL сценарий: два TDTP-источника → SQLite workspace → TDTP-выход
# Использование: tdtpcli --pipeline pipeline-basic.yaml
name: "employee-dept-report"
version: "1.0"
description: "Зарплатный отчёт по отделам — JOIN из двух TDTP-источников"

sources:
  - name: employees
    type: tdtp
    dsn: "examples/encryption-test/employees.tdtp.xml"

  - name: departments
    type: tdtp
    dsn: "examples/encryption-test/departments.tdtp.xml"

workspace:
  type: sqlite
  mode: ":memory:"

transform:
  result_table: "dept_salary_report"
  sql: |
    SELECT
      d.department_name,
      COUNT(e.employee_id)    AS headcount,
      ROUND(AVG(e.salary), 2) AS avg_salary,
      SUM(e.salary)           AS total_salary,
      MIN(e.salary)           AS min_salary,
      MAX(e.salary)           AS max_salary
    FROM employees e
    JOIN departments d ON e.department_id = d.department_id
    WHERE e.is_active = 1
    GROUP BY d.department_id, d.department_name
    ORDER BY total_salary DESC

output:
  type: tdtp
  tdtp:
    destination: "examples/encryption-test/out/dept_salary_report.xml"
    format: "xml"
    compression: false

error_handling:
  on_source_error: "fail"
