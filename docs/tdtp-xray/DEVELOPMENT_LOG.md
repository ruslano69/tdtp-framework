# TDTP X-Ray - Development Log

## Phase 1: Foundation ✅ (2025-02-13)

### Completed Tasks

#### 1. Project Structure Created
```
cmd/tdtp-xray/
├── main.go                    ✅ Wails entry point
├── app.go                     ✅ Go API with all types & methods
├── frontend/
│   ├── wails.json             ✅ Wails configuration
│   ├── src/
│   │   ├── index.html         ✅ Main UI shell
│   │   ├── styles/
│   │   │   ├── main.css       ✅ Windows Forms inspired
│   │   │   └── wizard.css     ✅ Wizard navigation styles
│   │   └── scripts/
│   │       └── wizard.js      ✅ Wizard logic + Step 1 implemented
│   └── dist/                  (will be generated by Wails)
└── services/                  (Phase 2)
```

#### 2. Core Types Defined (app.go)

**Wizard Steps:**
- ✅ Step 1: `PipelineInfo` (name, version, description)
- ✅ Step 2: `Source` + `ConnectionResult` + Mock/Production mode
- ✅ Step 3: `CanvasDesign` + `TableDesign` + `JoinDesign`
- ✅ Step 4: `Transform` (SQL transformation)
- ✅ Step 5: `Output` (File, Broker, Database, XLSX, IncrementalSync)
- ✅ Step 6: `Settings` (Performance, Workspace, Audit, ErrorHandling, Processors)
- ✅ Step 7: Preview & YAML generation

**Key Features:**
- ✅ Mock/Production mode switching
- ✅ Step validation (`ValidateStep`)
- ✅ State management (sources, canvas, output, etc.)

#### 3. Frontend UI

**Implemented:**
- ✅ Windows Forms inspired design (gray gradients, classic buttons)
- ✅ 7-step wizard navigation
- ✅ Mock/Production mode switcher (header)
- ✅ Step 1 fully functional (Project Info form)
- ✅ Navigation buttons (Back/Next) with validation
- ✅ Notification system (footer status messages)

**Styling:**
- ✅ Classic Windows Forms colors (#f0f0f0, #0078d7)
- ✅ Gradient buttons
- ✅ Segoe UI font
- ✅ Hover effects, focus states

#### 4. Documentation

- ✅ `TECHNICAL_SPEC.md` - Full specification
- ✅ `DEVELOPMENT_LOG.md` - This file
- ✅ Key decisions documented:
  - Windows-first platform
  - SVG canvas for Step 3
  - Mock/Prod modes
  - Integration with tdtpcli

---

## Key Decisions Made

### 1. Platform Priority
**Decision:** Windows 10/11 first, Linux optional
**Rationale:** User has no Linux testing environment, GUI not popular on Linux servers

### 2. Visual Designer Technology
**Decision:** SVG canvas (not Canvas API)
**Rationale:**
- Easy DOM manipulation
- Click events on elements (lines, tables)
- CSS styling support
- Zoom/pan with CSS transforms

**Example JOIN line:**
```html
<line id="join-1"
      x1="200" y1="120"
      x2="350" y2="120"
      onclick="showJoinProperties('join-1')"/>
```

### 3. Execution Model
**Decision:** X-Ray generates YAML → tdtpcli executes
**Rationale:**
- Reuse existing battle-tested code
- Find framework bugs through real usage
- X-Ray focuses on UI/config generation
- Preview via `tdtpcli --preview --limit 10`

### 4. Validation Strategy
**Decision:** Two modes (Mock + Production)

**Mock Mode:**
- JSON mock sources allowed
- ⚠️ Warnings, but can proceed
- For learning/prototyping

**Production Mode:**
- Only real DB/TDTP/RabbitMQ sources
- ❌ Strict validation
- Can't proceed without Test Connection

### 5. Top 3 Use Cases (Templates)
1. **SQLite → filter → File**
   - Single source
   - Field filtering
   - TDTP XML output

2. **MSSQL multi-table JOIN → RabbitMQ**
   - Multiple sources
   - Visual JOIN designer
   - Broker output

3. **RabbitMQ → DB enrichment → RabbitMQ**
   - TDTP input source
   - DB lookup
   - Transform + broker output

---

## Next Steps (Phase 2)

### Priority 1: Core Services
- [ ] `connection_service.go` - Test DB connections
  - Implement real connection testing
  - Return table list, connection time
  - Handle errors gracefully

- [ ] `metadata_service.go` - GetTables/GetViews/GetSchema
  - Query INFORMATION_SCHEMA
  - Support all DBs (Postgres, MSSQL, MySQL, SQLite)
  - Return field types, keys, constraints

- [ ] `source_service.go` - Enhanced source management
  - Mock source loader (from JSON)
  - Validation rules
  - Schema inference for TDTP sources

### Priority 2: Step 2 UI (Sources)
- [ ] Source list with Add/Edit/Remove buttons
- [ ] Source type dropdown (DB, TDTP, Mock)
- [ ] Connection test modal
- [ ] Table/View selector
- [ ] Query editor with syntax highlighting
- [ ] Preview button → Preview panel

### Priority 3: Preview Service
- [ ] `preview_service.go` - Data preview
  - Add LIMIT to user queries (MSSQL: TOP, Oracle: ROWNUM)
  - Execute preview queries
  - Format results as JSON
  - Calculate approximate row count

---

## Technical Notes

### Wails Integration

**Build command (not yet tested):**
```bash
cd cmd/tdtp-xray
wails dev   # Development mode with hot reload
wails build # Production build
```

**Frontend-Backend Communication:**
```javascript
// Frontend calls Go methods
const result = await window.go.main.App.TestSource(source);

// Go returns JSON
type ConnectionResult struct {
    Success  bool
    Message  string
    Duration int
    Tables   []string
}
```

### Mock Source Format

**JSON Example:**
```json
{
  "name": "mock_users",
  "type": "mock",
  "schema": [
    {"name": "id", "type": "int", "key": true},
    {"name": "name", "type": "string"},
    {"name": "email", "type": "string"}
  ],
  "data": [
    {"id": 1, "name": "Alice", "email": "alice@example.com"},
    {"id": 2, "name": "Bob", "email": "bob@example.com"}
  ]
}
```

### Challenges Encountered

1. **No Wails CLI installed yet**
   - Solution: Will install in Phase 2 when ready to test
   - Can develop structure first

2. **SVG Canvas Complexity**
   - Decision: Start with simple drag-n-drop in Phase 3
   - Use SVG.js or plain SVG with event handlers

3. **Cross-DB Query Compatibility**
   - Challenge: LIMIT syntax varies
   - Solution: Dialect detection + query transformation

---

## Code Statistics

- **Go code:** ~500 lines (app.go + main.go)
- **HTML:** ~100 lines (index.html)
- **CSS:** ~350 lines (main.css + wizard.css)
- **JavaScript:** ~300 lines (wizard.js)

**Total:** ~1,250 lines

---

## Roadmap

- [x] Phase 1: Foundation (✅ COMPLETE)
- [ ] Phase 2: Core Services (NEXT)
- [ ] Phase 3: Visual Designer (SVG Canvas)
- [ ] Phase 4: Preview & Testing
- [ ] Phase 5: Polish & Release

---

## Notes for Future Development

### Step 3 (Visual Designer) Technical Approach

**SVG Canvas Layout:**
```html
<svg id="canvas" width="1000" height="700">
  <!-- Grid background -->
  <defs>
    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
      <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="1"/>
    </pattern>
  </defs>
  <rect width="100%" height="100%" fill="url(#grid)" />

  <!-- Tables (draggable groups) -->
  <g id="table-orders" class="table-group" transform="translate(50, 50)">
    <!-- Table implementation -->
  </g>

  <!-- JOIN lines -->
  <line class="join-line" ... />
</svg>
```

**Drag-n-Drop:**
- Use `mousedown`, `mousemove`, `mouseup` events
- Update `transform="translate(x, y)"`
- Snap to grid (optional)

**JOIN Drawing:**
1. Click source field → start line
2. Move mouse → line follows cursor
3. Click target field → finalize JOIN
4. Show popup for JOIN type (INNER/LEFT/RIGHT)

### Mock Mode UX

**Warning Messages:**
```
⚠️ Mock Mode Active

You are using mock source "fake_orders".
This configuration will NOT work in production.

[Switch to Real Source] [Continue Anyway]
```

**Production Mode Error:**
```
❌ Cannot Proceed

Source "orders" has not been tested.

Action required:
1. Go back to Step 2
2. Click [Test Connection] on "orders" source
3. Verify connection is successful

[Go to Step 2]
```

---

Last Updated: 2025-02-13
Next Review: After Phase 2 completion
