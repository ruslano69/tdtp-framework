# TDTP X-Ray - Development Log

## Phase 1: Foundation ✅ (2025-02-13)

### Completed Tasks

#### 1. Project Structure Created
```
cmd/tdtp-xray/
├── main.go                    ✅ Wails entry point
├── app.go                     ✅ Go API with all types & methods
├── frontend/
│   ├── wails.json             ✅ Wails configuration
│   ├── src/
│   │   ├── index.html         ✅ Main UI shell
│   │   ├── styles/
│   │   │   ├── main.css       ✅ Windows Forms inspired
│   │   │   └── wizard.css     ✅ Wizard navigation styles
│   │   └── scripts/
│   │       └── wizard.js      ✅ Wizard logic + Step 1 implemented
│   └── dist/                  (will be generated by Wails)
└── services/                  (Phase 2)
```

#### 2. Core Types Defined (app.go)

**Wizard Steps:**
- ✅ Step 1: `PipelineInfo` (name, version, description)
- ✅ Step 2: `Source` + `ConnectionResult` + Mock/Production mode
- ✅ Step 3: `CanvasDesign` + `TableDesign` + `JoinDesign`
- ✅ Step 4: `Transform` (SQL transformation)
- ✅ Step 5: `Output` (File, Broker, Database, XLSX, IncrementalSync)
- ✅ Step 6: `Settings` (Performance, Workspace, Audit, ErrorHandling, Processors)
- ✅ Step 7: Preview & YAML generation

**Key Features:**
- ✅ Mock/Production mode switching
- ✅ Step validation (`ValidateStep`)
- ✅ State management (sources, canvas, output, etc.)

#### 3. Frontend UI

**Implemented:**
- ✅ Windows Forms inspired design (gray gradients, classic buttons)
- ✅ 7-step wizard navigation
- ✅ Mock/Production mode switcher (header)
- ✅ Step 1 fully functional (Project Info form)
- ✅ Navigation buttons (Back/Next) with validation
- ✅ Notification system (footer status messages)

**Styling:**
- ✅ Classic Windows Forms colors (#f0f0f0, #0078d7)
- ✅ Gradient buttons
- ✅ Segoe UI font
- ✅ Hover effects, focus states

#### 4. Documentation

- ✅ `TECHNICAL_SPEC.md` - Full specification
- ✅ `DEVELOPMENT_LOG.md` - This file
- ✅ Key decisions documented:
  - Windows-first platform
  - SVG canvas for Step 3
  - Mock/Prod modes
  - Integration with tdtpcli

---

## Key Decisions Made

### 1. Platform Priority
**Decision:** Windows 10/11 first, Linux optional
**Rationale:** User has no Linux testing environment, GUI not popular on Linux servers

### 2. Visual Designer Technology
**Decision:** SVG canvas (not Canvas API)
**Rationale:**
- Easy DOM manipulation
- Click events on elements (lines, tables)
- CSS styling support
- Zoom/pan with CSS transforms

**Example JOIN line:**
```html
<line id="join-1"
      x1="200" y1="120"
      x2="350" y2="120"
      onclick="showJoinProperties('join-1')"/>
```

### 3. Execution Model
**Decision:** X-Ray generates YAML → tdtpcli executes
**Rationale:**
- Reuse existing battle-tested code
- Find framework bugs through real usage
- X-Ray focuses on UI/config generation
- Preview via `tdtpcli --preview --limit 10`

### 4. Validation Strategy
**Decision:** Two modes (Mock + Production)

**Mock Mode:**
- JSON mock sources allowed
- ⚠️ Warnings, but can proceed
- For learning/prototyping

**Production Mode:**
- Only real DB/TDTP/RabbitMQ sources
- ❌ Strict validation
- Can't proceed without Test Connection

### 5. Top 3 Use Cases (Templates)
1. **SQLite → filter → File**
   - Single source
   - Field filtering
   - TDTP XML output

2. **MSSQL multi-table JOIN → RabbitMQ**
   - Multiple sources
   - Visual JOIN designer
   - Broker output

3. **RabbitMQ → DB enrichment → RabbitMQ**
   - TDTP input source
   - DB lookup
   - Transform + broker output

---

## Phase 2: Core Services ✅ (2025-02-13)

### Completed Tasks

#### 1. Core Services Implementation

**connection_service.go** ✅
- Real database connection testing (Postgres, MySQL, MSSQL, SQLite)
- Table and view list retrieval
- Connection timing measurement
- Driver mapping (user-friendly types → driver names)
- Quick test mode (fast ping without metadata)

**metadata_service.go** ✅
- GetTableSchema() - retrieves full column metadata
- Column information: name, data type, nullable, primary key, max length, default value
- INFORMATION_SCHEMA queries for Postgres, MySQL, MSSQL
- PRAGMA table_info for SQLite
- Primary key detection for all databases
- TDTP schema inference (placeholder for future)

**source_service.go** ✅
- LoadMockSource() - loads JSON mock sources from files
- ValidateMockSource() - validates schema and data integrity
- ValidateRealSource() - validates DB sources with connection test
- Mock source template generation
- InferSchemaFromTable() - creates mock source from real table
- Data type mapping (DB types → mock types)

**preview_service.go** ✅
- PreviewQuery() - executes queries with LIMIT
- Dialect-aware LIMIT injection (LIMIT for Postgres/MySQL/SQLite, TOP for MSSQL)
- PreviewMockSource() - previews mock data
- EstimateRowCount() - approximate row count for tables
- Query syntax validation (SELECT only, no dangerous keywords)
- Value conversion for JSON compatibility

#### 2. App Integration (app.go)

**Services Integration** ✅
- All 4 services instantiated in NewApp()
- TestSource() now uses ConnectionService
- GetTables() - retrieves table/view list
- GetTableSchema() - retrieves full schema
- LoadMockSourceFile() - loads mock sources
- PreviewSource() updated to use PreviewService
- Support for both real DB and mock source previews

#### 3. Step 2 UI (Sources Management)

**UI Components** ✅
- Source list with visual status indicators (✅/⚠️)
- Add/Edit/Remove buttons
- Source form with type selection (Postgres, MySQL, MSSQL, SQLite, Mock)
- Database connection fields (DSN, Query)
- Mock source JSON editor
- Test Connection button with real-time results
- Preview panel with table rendering
- Form validation (client-side)

**JavaScript Functions** ✅
- `renderSourceList()` - dynamic source list rendering
- `showAddSourceForm()` / `editSource()` - form management
- `testConnection()` - connection testing with backend
- `saveSourceForm()` - save to backend + local state
- `previewSource()` - data preview with table display
- `onSourceTypeChange()` - dynamic field visibility
- localStorage fallback for offline mode

---

## Next Steps (Phase 3: Visual Designer)

### Priority 1: SVG Canvas Foundation
- [ ] Create SVG canvas component
- [ ] Grid background with zoom/pan support
- [ ] Drag-n-drop for table elements
- [ ] Table rendering (fields list)

### Priority 2: JOIN Drawing
- [ ] Line drawing on field click
- [ ] JOIN type selector (INNER/LEFT/RIGHT)
- [ ] JOIN properties modal
- [ ] Visual line styling

### Priority 3: SQL Generation
- [ ] Generate SQL from canvas design
- [ ] Handle multiple JOINs
- [ ] Field filtering integration
- [ ] CAST support for type mismatches

---

## Technical Notes

### Wails Integration

**Build command (not yet tested):**
```bash
cd cmd/tdtp-xray
wails dev   # Development mode with hot reload
wails build # Production build
```

**Frontend-Backend Communication:**
```javascript
// Frontend calls Go methods
const result = await window.go.main.App.TestSource(source);

// Go returns JSON
type ConnectionResult struct {
    Success  bool
    Message  string
    Duration int
    Tables   []string
}
```

### Mock Source Format

**JSON Example:**
```json
{
  "name": "mock_users",
  "type": "mock",
  "schema": [
    {"name": "id", "type": "int", "key": true},
    {"name": "name", "type": "string"},
    {"name": "email", "type": "string"}
  ],
  "data": [
    {"id": 1, "name": "Alice", "email": "alice@example.com"},
    {"id": 2, "name": "Bob", "email": "bob@example.com"}
  ]
}
```

### Challenges Encountered

1. **No Wails CLI installed yet**
   - Solution: Will install in Phase 2 when ready to test
   - Can develop structure first

2. **SVG Canvas Complexity**
   - Decision: Start with simple drag-n-drop in Phase 3
   - Use SVG.js or plain SVG with event handlers

3. **Cross-DB Query Compatibility**
   - Challenge: LIMIT syntax varies
   - Solution: Dialect detection + query transformation

---

## Code Statistics

- **Go code:** ~500 lines (app.go + main.go)
- **HTML:** ~100 lines (index.html)
- **CSS:** ~350 lines (main.css + wizard.css)
- **JavaScript:** ~300 lines (wizard.js)

**Total:** ~1,250 lines

---

## Roadmap

- [x] Phase 1: Foundation (✅ COMPLETE)
- [ ] Phase 2: Core Services (NEXT)
- [ ] Phase 3: Visual Designer (SVG Canvas)
- [ ] Phase 4: Preview & Testing
- [ ] Phase 5: Polish & Release

---

## Notes for Future Development

### Step 3 (Visual Designer) Technical Approach

**SVG Canvas Layout:**
```html
<svg id="canvas" width="1000" height="700">
  <!-- Grid background -->
  <defs>
    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
      <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="1"/>
    </pattern>
  </defs>
  <rect width="100%" height="100%" fill="url(#grid)" />

  <!-- Tables (draggable groups) -->
  <g id="table-orders" class="table-group" transform="translate(50, 50)">
    <!-- Table implementation -->
  </g>

  <!-- JOIN lines -->
  <line class="join-line" ... />
</svg>
```

**Drag-n-Drop:**
- Use `mousedown`, `mousemove`, `mouseup` events
- Update `transform="translate(x, y)"`
- Snap to grid (optional)

**JOIN Drawing:**
1. Click source field → start line
2. Move mouse → line follows cursor
3. Click target field → finalize JOIN
4. Show popup for JOIN type (INNER/LEFT/RIGHT)

### Mock Mode UX

**Warning Messages:**
```
⚠️ Mock Mode Active

You are using mock source "fake_orders".
This configuration will NOT work in production.

[Switch to Real Source] [Continue Anyway]
```

**Production Mode Error:**
```
❌ Cannot Proceed

Source "orders" has not been tested.

Action required:
1. Go back to Step 2
2. Click [Test Connection] on "orders" source
3. Verify connection is successful

[Go to Step 2]
```

---

Last Updated: 2025-02-13
Next Review: After Phase 2 completion
